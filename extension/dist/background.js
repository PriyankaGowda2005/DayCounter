import{c}from"./utils.js";chrome.runtime.onInstalled.addListener(()=>{console.log("DayCounter extension installed"),chrome.notifications.getPermissionLevel(e=>{e==="denied"&&console.log("Notifications denied by user")})});chrome.alarms.onAlarm.addListener(e=>{e.name.startsWith("reminder-")?m(e):e.name==="daily-summary"&&l()});async function m(e){try{const n=e.name.replace("reminder-",""),i=((await chrome.storage.local.get(["events"])).events||[]).find(t=>t.id===n);if(!i)return;const a=c(i.targetAt,i.startAt);chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"DayCounter Reminder",message:`${i.title} - ${a.isOverdue?"Overdue!":`${a.days} days remaining`}`,buttons:[{title:"View Details"}]})}catch(n){console.error("Error handling reminder alarm:",n)}}async function l(){try{const e=await chrome.storage.local.get(["events","dailySummaryTime"]),n=e.events||[],o=e.dailySummaryTime||"09:00",r=new Date,i=n.filter(t=>new Date(t.targetAt).toDateString()===r.toDateString()&&!t.isArchived),a=n.filter(t=>new Date(t.targetAt)>r&&!t.isArchived).slice(0,3);if(i.length>0||a.length>0){let t="";i.length>0&&(t+=`Today: ${i.length} event${i.length>1?"s":""}`),a.length>0&&(t&&(t+=`
`),t+=`Upcoming: ${a.map(s=>s.title).join(", ")}`),chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:"DayCounter Daily Summary",message:t,buttons:[{title:"View All Events"}]})}}catch(e){console.error("Error handling daily summary alarm:",e)}}chrome.notifications.onClicked.addListener(e=>{chrome.tabs.create({url:"https://daycounter.app"})});chrome.notifications.onButtonClicked.addListener((e,n)=>{chrome.tabs.create({url:"https://daycounter.app"})});async function d(e){try{(await chrome.alarms.getAll()).forEach(o=>{o.name.startsWith(`reminder-${e.id}`)&&chrome.alarms.clear(o.name)});for(const o of e.reminders){const r=new Date(e.targetAt);r.setMinutes(r.getMinutes()+o.offsetMinutesFromTarget),r>new Date&&chrome.alarms.create(`reminder-${e.id}-${o.id}`,{when:r.getTime()})}}catch(n){console.error("Error scheduling reminders:",n)}}chrome.storage.onChanged.addListener((e,n)=>{n==="local"&&e.events&&(e.events.newValue||[]).forEach(r=>{r.isArchived||d(r)})});chrome.commands.onCommand.addListener(e=>{e==="open-popup"&&chrome.action.openPopup()});
